#! /bin/bash

W_=${W:-tmp}
export -n W_
case $W_ in
  /*)	;;
  *)	W_=@abs_top_builddir@/$W_;;
esac

_s=$W_/sysroots/`uname -m`-linux
: ${PYTHON:='@PYTHON@'}
: ${BITBAKE_UI='@BITBAKE_UI@'}
PATH=$PATH:/usr/local/sbin:/usr/sbin:/sbin:$_s/usr/bin
CCACHE_DIR=$W_/cache/ccache
INSTALL='@INSTALL@'
BBPATH='@abs_top_builddir@'
ELITO_METRICS_ID=$$
ELITO_PROJECT_NAME='@PROJECT_NAME@'
ELITO_SCRIPTS_DIR='@abs_top_srcdir@/scripts'
ELITO_OOM_ADJUST='@ELITO_OOM_ADJUST@'

@ENABLE_CCACHE_TRUE@@WHICH@ ccache >/dev/null 2>/dev/null && export CCACHE=${CCACHE:-ccache}

@ENABLE_CGROUPS_TRUE@ELITO_CGROUP_NAME="elito_@PROJECT_NAME@"
@ENABLE_CGROUPS_FALSE@ELITO_CGROUP_NAME=

for i in "${!_@}" \
    ENV OPTS MAKEFLAGS MAKEOVERRIDES POSIXLY_CORRECT \
    ACLOCAL_FLAGS OSTYPE HOSTTYPE ARCH CPU BOARD VENDOR SOC \
    LD_LIBRARY_PATH LD_PRELOAD MAIL MAILCHECK MAILPATH \
    DIRSTACK OPTERR OPTIND SHLVL HOST HOSTFILE \
    PKG_CONFIG_PATH PYTHONSTARTUP PROFILEREAD \
    DESKTOP_SESSION \
; do
	eval unset "$i"
done

export BITBAKE_UI
export ELITO_METRICS_ID
export CCACHE_DIR BBPATH

for f in '@abs_top_builddir@'/set-env.local $HOME/.elito-set-env; do
    test -r "$f" || continue
    . "$f"
done

exec_secure() {
    if test -z "$ELITO_NO_SECWRAP_CMD"; then
	exec @SECWRAP_CMD@ "$@"
    else
	unset ELITO_NO_SECWRAP_CMD
	exec "$@"
    fi
}
