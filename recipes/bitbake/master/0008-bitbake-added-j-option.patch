From ce6f9970ab48c5723c9ed4f3d4504b90bb09ec5f Mon Sep 17 00:00:00 2001
From: Enrico Scholz <enrico.scholz@sigma-chemnitz.de>
Date: Sun, 20 May 2012 16:23:30 +0200
Subject: [PATCH 08/12] bitbake: added -j option

This patch adds an -j option which overrides/sets BB_NUMBER_THREADS.
For some use cases like '-c fetchall' it might be useful to modify
temporarily the number of parallel running tasks without editing
bitbake.conf.

Signed-off-by: Enrico Scholz <enrico.scholz@sigma-chemnitz.de>
---
 bin/bitbake      | 4 ++++
 doc/bitbake.1    | 4 ++++
 lib/bb/cooker.py | 7 +++++++
 3 files changed, 15 insertions(+)

diff --git a/bin/bitbake b/bin/bitbake
index 40b50e1..e090aab 100755
--- a/bin/bitbake
+++ b/bin/bitbake
@@ -184,6 +184,10 @@ Default BBFILES are the .bb files in the current directory.""")
                action = "store", dest = "bind", default = False)
     parser.add_option("", "--no-setscene", help = "Do not run any setscene tasks, forces builds",
                action = "store_true", dest = "nosetscene", default = False)
+
+    parser.add_option("-j", "--jobs", help = "The number of threads BitBake should run at once",
+                      action = "store", dest = "number_threads", default = None)
+
     options, args = parser.parse_args(sys.argv)
 
     configuration = BBConfiguration(options)
diff --git a/doc/bitbake.1 b/doc/bitbake.1
index 15a7f20..66642af 100644
--- a/doc/bitbake.1
+++ b/doc/bitbake.1
@@ -98,6 +98,10 @@ emit the dependency trees of the specified packages in the dot syntax
 Stop processing at the given list of dependencies when generating dependency
 graphs. This can help to make the graph more appealing
 .TP
+.B \-j\fR [\fIjobs\fR], \fB\-\-jobs\fR[=\fIjobs\fR]
+The number of threads BitBake should run at once.  This option
+overrides the \fI${BB_NUMBER_THREADS}\fR configuration variable.
+.TP
 .B \-lDEBUG_DOMAINS, \-\-log-domains=DEBUG_DOMAINS
 Show debug logging for the specified logging domains
 .TP
diff --git a/lib/bb/cooker.py b/lib/bb/cooker.py
index 4ee3881..c158710 100644
--- a/lib/bb/cooker.py
+++ b/lib/bb/cooker.py
@@ -142,6 +142,13 @@ class BBCooker:
         self.configuration.data = None
         self.loadConfigurationData()
 
+        if self.configuration.number_threads != None:
+            num = int(self.configuration.number_threads)
+            if num == 0:
+                num = multiprocessing.cpu_count()
+
+            self.configuration.data.setVar("BB_NUMBER_THREADS", str(num))
+
         # Take a lock so only one copy of bitbake can run against a given build
         # directory at a time
         lockfile = self.configuration.data.expand("${TOPDIR}/bitbake.lock")
-- 
1.8.1.4

