From 3a86cb7faa1101db4e60f46d9f668fd53d8e4a7b Mon Sep 17 00:00:00 2001
From: Enrico Scholz <enrico.scholz@informatik.tu-chemnitz.de>
Date: Sat, 16 Jul 2011 13:41:43 +0200
Subject: [PATCH 06/17] do not bail out on SkipPackage exceptions

set __SKIPPED instead of
---
 lib/bb/data_smart.py               |  2 ++
 lib/bb/parse/parse_py/BBHandler.py | 10 +++++++++-
 2 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/lib/bb/data_smart.py b/lib/bb/data_smart.py
index fb8d9d5..739864d 100644
--- a/lib/bb/data_smart.py
+++ b/lib/bb/data_smart.py
@@ -141,6 +141,8 @@ class DataSmart(MutableMapping):
                 s = __expand_python_regexp__.sub(varparse.python_sub, s)
                 if s == olds:
                     break
+            except bb.parse.SkipPackage:
+                raise
             except ExpansionError:
                 raise
             except Exception as exc:
diff --git a/lib/bb/parse/parse_py/BBHandler.py b/lib/bb/parse/parse_py/BBHandler.py
index 2e0647b..f2adea3 100644
--- a/lib/bb/parse/parse_py/BBHandler.py
+++ b/lib/bb/parse/parse_py/BBHandler.py
@@ -148,10 +148,18 @@ def handle(fn, d, include):
     if ext != ".bbclass":
         data.setVar('FILE', abs_fn, d)
 
-    statements.eval(d)
+    try:
+        statements.eval(d)
+    except bb.parse.SkipPackage:
+        bb.data.setVar("__SKIPPED", True, d)
 
     if ext == ".bbclass":
         classes.remove(__classname__)
+    elif bb.data.getVar("__SKIPPED", d, True):
+        if include == 0:
+            return { "" : d }
+        else:
+            return d
     else:
         if include == 0:
             return ast.multi_finalize(fn, d)
-- 
1.7.11.7

