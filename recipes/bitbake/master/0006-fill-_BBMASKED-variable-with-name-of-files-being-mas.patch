From dcf7330b3de578aaba211be5ef60f7f1fdca021e Mon Sep 17 00:00:00 2001
From: Enrico Scholz <enrico.scholz@informatik.tu-chemnitz.de>
Date: Sat, 16 Jul 2011 13:41:45 +0200
Subject: [PATCH 06/12] fill _BBMASKED variable with name of files being
 masked out

---
 lib/bb/cooker.py |   16 +++++++++++++++-
 1 files changed, 15 insertions(+), 1 deletions(-)

diff --git a/lib/bb/cooker.py b/lib/bb/cooker.py
index 0880b0f..173e124 100644
--- a/lib/bb/cooker.py
+++ b/lib/bb/cooker.py
@@ -1276,9 +1276,12 @@ class BBCooker:
 
         bbfiles = []
         bbappend = []
+        maskedfiles = []
         for f in newfiles:
             if bbmask and bbmask_compiled.search(f):
-                collectlog.debug(1, "skipping masked file %s", f)
+                collectlog.debug(2, "skipping masked file %s", f)
+                if bb.msg.debug_level[bb.msg.domain.Collection] >= 1:
+                    maskedfiles.append(f)
                 masked += 1
                 continue
             if f.endswith('.bb'):
@@ -1308,6 +1311,11 @@ class BBCooker:
                 topfile = bbfile_seen[base]
                 self.overlayed[topfile].append(f)
 
+        if bb.msg.debug_level[bb.msg.domain.Collection] >= 1:
+            bb.data.setVar("_BBMASKED", maskedfiles, self.configuration.data)
+            bb.event.fire(CookerNewFiles(bbfiles, maskedfiles),
+                          self.configuration.data)
+
         return (bbfiles, masked)
 
     def get_file_appends(self, fn):
@@ -1432,6 +1440,12 @@ def parse_file(task):
     except BaseException as exc:
         raise ParsingFailure(exc, filename)
 
+class CookerNewFiles(bb.event.Event):
+    def __init__(self, finalfiles, maskedfiles):
+        bb.event.Event.__init__(self)
+        self.finalfiles = finalfiles
+        self.maskedfiles = maskedfiles
+
 class CookerParser(object):
     def __init__(self, cooker, filelist, masked):
         self.filelist = filelist
-- 
1.7.6

