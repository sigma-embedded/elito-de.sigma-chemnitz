From 405df9007417d70afe857513d5fd599768cbccda Mon Sep 17 00:00:00 2001
From: Enrico Scholz <enrico.scholz@informatik.tu-chemnitz.de>
Date: Sat, 16 Jul 2011 13:41:43 +0200
Subject: [PATCH 03/16] added find-dups functions

it is activated by a debug level of collection domain >= 1
---
 lib/bb/cooker.py |   52 ++++++++++++++++++++++++++++++++++++++++++++++++++++
 1 files changed, 52 insertions(+), 0 deletions(-)

diff --git a/lib/bb/cooker.py b/lib/bb/cooker.py
index dea0aad..d2f8404 100644
--- a/lib/bb/cooker.py
+++ b/lib/bb/cooker.py
@@ -1170,6 +1170,54 @@ class BBCooker:
 
         self.server_registration_cb(buildTargetsIdle, rq)
 
+    def findDups(self):
+        ignores = bb.data.getVar("PKGDUP_IGNORES", self.configuration.data, 1) or ""
+        ignores = dict(map(lambda x: (x,0), ignores.split()))
+
+        dupes   = {}
+        scm_suf = re.compile('.*[-+_](svn|cvs|git|hg)\\.bb$')
+
+        for (pn,fns) in self.status.pkg_pn.items():
+            if len(fns) <= 1:
+                continue
+
+            tmp = []
+            for f in fns:
+                if f.startswith('virtual:') or scm_suf.match(f):
+                    continue
+
+                pepvpr = self.status.pkg_pepvpr[f]
+                label  = "%s:%s-%s" % pepvpr
+                bname  = os.path.basename(f).rstrip('.bb')
+
+                if ignores.has_key(bname):
+                    ignores[bname] = 1
+                    continue
+
+                tmp.append([pepvpr, label, f])
+
+            if len(tmp) <= 1:
+                continue
+
+            assert not dupes.has_key(pn)
+            dupes[pn] = tmp
+
+        dmap = dupes.items()
+        dmap.sort(cmp = (lambda x,y: cmp(x[0], y[0])))
+
+        for (pn, entries) in dmap:
+            entries.sort(cmp = (lambda x,y: utils.vercmp(x[0], y[0])))
+
+            print(pn + '(' + (", ".join(map(lambda x: x[1], entries))) + ')')
+
+            for e in entries:
+                print("    " + e[2])
+
+        eignores = filter(lambda (x,y): y == 0, ignores.items())
+        for i in eignores:
+            bb.msg.warn(bb.msg.domain.Collection,
+                        "unused '%s' pkgdup ignore" % i[0])
+
     def updateCache(self):
         if self.state == state.running:
             return
@@ -1201,6 +1249,10 @@ class BBCooker:
 
         if not self.parser.parse_next():
             collectlog.debug(1, "parsing complete")
+
+            if collectlog.level >= 1:
+                self.findDups()
+
             self.show_appends_with_no_recipes()
             self.buildDepgraph()
             self.state = state.running
-- 
1.7.7.6

