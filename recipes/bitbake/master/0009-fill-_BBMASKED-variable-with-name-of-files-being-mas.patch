From cb30eddf3140eea1e7ade5b76ffd85cab7202f5b Mon Sep 17 00:00:00 2001
From: Enrico Scholz <enrico.scholz@informatik.tu-chemnitz.de>
Date: Sat, 16 Jul 2011 13:41:45 +0200
Subject: [PATCH 09/20] fill _BBMASKED variable with name of files being
 masked out

---
 lib/bb/cooker.py |   16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/lib/bb/cooker.py b/lib/bb/cooker.py
index 4a59864..72163e9 100644
--- a/lib/bb/cooker.py
+++ b/lib/bb/cooker.py
@@ -1353,9 +1353,12 @@ class BBCooker:
 
         bbfiles = []
         bbappend = []
+        maskedfiles = []
         for f in newfiles:
             if bbmask and bbmask_compiled.search(f):
-                collectlog.debug(1, "skipping masked file %s", f)
+                collectlog.debug(2, "skipping masked file %s", f)
+                if collectlog.level >= 1:
+                    maskedfiles.append(f)
                 masked += 1
                 continue
             if f.endswith('.bb'):
@@ -1385,6 +1388,11 @@ class BBCooker:
                 topfile = bbfile_seen[base]
                 self.overlayed[topfile].append(f)
 
+        if collectlog.level >= 1:
+            bb.data.setVar("_BBMASKED", maskedfiles, self.configuration.data)
+            bb.event.fire(CookerNewFiles(bbfiles, maskedfiles),
+                          self.configuration.data)
+
         return (bbfiles, masked)
 
     def get_file_appends(self, fn):
@@ -1582,6 +1590,12 @@ class Parser(multiprocessing.Process):
         except BaseException as exc:
             return True, ParsingFailure(exc, filename)
 
+class CookerNewFiles(bb.event.Event):
+    def __init__(self, finalfiles, maskedfiles):
+        bb.event.Event.__init__(self)
+        self.finalfiles = finalfiles
+        self.maskedfiles = maskedfiles
+
 class CookerParser(object):
     def __init__(self, cooker, filelist, masked):
         self.filelist = filelist
-- 
1.7.10.4

