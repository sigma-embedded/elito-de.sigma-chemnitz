PYTHON :=		python
SED :=			sed
SVN :=			svn
GIT :=			git
abs_top_srcdir :=	$(abspath @abs_top_srcdir@)
abs_top_builddir :=	$(abspath @abs_top_builddir@)

ELITO_ROOTDIR :=	$(abspath $(abs_top_srcdir)/..)
CACHE_DIR :=		$(abspath @_CACHE_DIR@)
PROJECT_NAME :=		@PROJECT_NAME@
QUILT :=		@QUILT@
INSTALL :=		@INSTALL@

INSTALL_DATA =		$(INSTALL) -p -m 0644

VPATH ?=		$(abs_top_srcdir)

SED_EXPR :=	-e 's!@'ELITO_ROOTDIR'@!$(ELITO_ROOTDIR)!g'		\
		-e 's!@'CACHE_DIR'@!$(CACHE_DIR)!g'			\
		-e 's!@'PROJECT_NAME'@!$(PROJECT_NAME)!g'

CHECKSUM_SORTER =	$(PYTHON) $(ELITO_ROOTDIR)/org.openembedded/contrib/source-checker/oe-checksums-sorter.py
CHECKSUM_FILE =		$(ELITO_ROOTDIR)/org.openembedded/conf/checksums.ini

BITBAKE_BRANCH =	1.8
BITBAKE_REPO =		git://git.openembedded.org/bitbake.git
BITBAKE_REV =		c16eeb1bc5a00ad036f56c97a339c775798abce5

AUTOCONF_FILES =	Makefile		\
			set-env.in		\
			conf/local.conf.in	\
			bitbake

CFG_FILES =		Makefile		\
			set-env			\
			conf/local.conf		\
			bitbake

TEMPLATE_FILES =	conf/project.conf	\
			.gitignore		\
			recipes/helloworld/helloworld.bb

_template_files =	$(addprefix $(abs_top_builddir)/,$(TEMPLATE_FILES))
_project_task_dir =	$(abs_top_builddir)/recipes/$(PROJECT_NAME)
_project_task_file =	$(_project_task_dir)/task-$(PROJECT_NAME).bb
_project_files_file =	$(_project_task_dir)/files-$(PROJECT_NAME).bb
_samples_dir =		$(abs_top_srcdir)/samples

config:			$(CFG_FILES) $(_template_files) .gitignore bitbake-validate
config:			$(_project_task_file) $(_project_files_file)

init:			bitbake-fetch

_bitbake_root =		$(abs_top_builddir)/tmp/staging/.bitbake

bitbake-fetch:		tmp/stamps/.bitbake.stamp
bitbake-clean:
			rm -rf tmp/bitbake $(_bitbake_root)
			rm -f tmp/stamps/.bitbake.*

bitbake-validate:
			@f=tmp/stamps/.bitbake.fetch.stamp; \
			test ! -e "$$f" || { \
			v=$$(cat $$f); test x"$$v" = x${BITBAKE_REV}; } || { \
			echo "****"; \
			echo "**** BITBAKE revision mismatch; you have $$v but ${BITBAKE_REV} is expected"; \
			echo "**** please run"; \
			echo "**** cd '$(abspath .)' && make bitbake-clean && make init"; \
			echo "****"; \
			exit 1; \
			} >&2

update-checksum:
			test -e tmp/checksums.ini
			t=$$(mktemp -t elito-crc.XXXXXX) && trap "rm -f $$t" EXIT && $(MAKE) .update-checksum _tmpfile=$$t

.update-checksum:
			cat tmp/checksums.ini >> $(CHECKSUM_FILE)
			$(CHECKSUM_SORTER) $(CHECKSUM_FILE) > $(_tmpfile)
			cat $(_tmpfile) >$(CHECKSUM_FILE)
			rm -f tmp/checksums.ini

tmp/stamps/.bitbake.fetch.stamp:	tmp/stamps/.bitbake.gitinit.stamp
			cd tmp/bitbake && $(GIT) remote update
			cd tmp/bitbake && $(GIT) merge ${BITBAKE_REV}
			@echo $(BITBAKE_REV) > $@

tmp/stamps/.bitbake.gitinit.stamp:
			@mkdir -p $(dir $@)
			mkdir -p tmp/bitbake
			cd tmp/bitbake && $(GIT) init
			cd tmp/bitbake && $(GIT) remote add origin ${BITBAKE_REPO}
			cd tmp/bitbake && $(GIT) config remote.origin.fetch refs/heads/${BITBAKE_BRANCH}:refs/remotes/origin/${BITBAKE_BRANCH}
			cd tmp/bitbake && $(GIT) config remote.origin.tagopt --no-tags
			cd tmp/bitbake && $(GIT) remote update
			cd tmp/bitbake && $(GIT) checkout -b master --track origin/${BITBAKE_BRANCH}
			@touch $@

tmp/stamps/.bitbake.patch.stamp:	tmp/stamps/.bitbake.fetch.stamp
ifeq ($(QUILT),)
			cd tmp/bitbake && cat $(abs_top_srcdir)/recipes/bitbake/*.patch | patch -p0
else
			cd tmp/bitbake && $(QUILT) pop -a || :
			rm -rf tmp/bitbake/patches tmp/bitbake/.pc
			mkdir -p tmp/bitbake/patches
			cd tmp/bitbake && $(QUILT) import -p0 $(abs_top_srcdir)/recipes/bitbake/*.patch
			cd tmp/bitbake && $(QUILT) push -a
endif
			@touch $@

tmp/stamps/.bitbake.stamp:	tmp/stamps/.bitbake.patch.stamp
			cd tmp/bitbake && $(PYTHON) setup.py build
			cd tmp/bitbake && $(PYTHON) setup.py install --prefix=$(_bitbake_root) --install-purelib=$(_bitbake_root)/lib -O2
			@touch $@

.gitignore:
			echo "${CFG_FILES}" | xargs -n1 echo > $@

$(_template_files):$(abs_top_builddir)/%:
			test ! -e $@
			mkdir -p $(dir $@)
			cp --preserve=mode,timestamps ${abs_top_srcdir}/$*.sample $@

$(_project_task_dir)/.stamp:
			mkdir -p '$(dir $@)' '$(dir $@)/rootfs' '$(dir $@)/rootfs/etc'
			$(INSTALL_DATA) $(_samples_dir)/Makefile          $(dir $@)Makefile
			$(INSTALL_DATA) $(_samples_dir)/.gitignore.sample $(dir $@).gitignore
			$(INSTALL_DATA) $(_samples_dir)/securetty         $(dir $@)rootfs/etc/securetty
			touch $@

$(_project_files_file) $(_project_task_file):	$(_project_task_dir)/.stamp
			test -e '$@' || \
			sed -e 's!@'PROJECT_NAME'@!$(PROJECT_NAME)!g' $(abs_top_srcdir)/samples/$(patsubst %-$(PROJECT_NAME).bb,%-project.bb,$(notdir $@)) > '$@'

# make timestamp older to prevent endless runs of this rules; it will
# not be good to do 'touch $@' here because this file is going to be
# edited by the user
			-@test "$<" -ot "$@" || touch --reference "$@" "$<"

%:			%.in
			@-rm -f $@.tmp $@
			$(SED) $(SED_EXPR) $< > $@.tmp
			mv $@.tmp $@
			chmod a-w $@

clean:
			rm -f set-env.in conf/local.conf bitbake

$(AUTOCONF_FILES): %:	config.status %.in
			$(abspath $<)

config.status:		$(abs_top_srcdir)/configure
			$(abspath $@) --recheck

@ENABLE_MAINTAINER_MODE_TRUE@$(abs_top_srcdir)/configure:	$(abs_top_srcdir)/configure.ac
@ENABLE_MAINTAINER_MODE_TRUE@					cd $(abs_top_srcdir) && autoreconf -i -f
