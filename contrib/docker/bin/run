#! /bin/bash

DISTRIBUTION=$1
RELEASE=$2
P=$3

set -e

. ./setup

_opts=(
  -p "$P":22
  --hostname="${CONTAINER_HOSTNAME}"
  --name="${FINAL_NAME}_${DISTRIBUTION}"
)

# there is no sense in using seccomp for SELinux enabled hosts and it
# breaks too much things (strace, ...)
! sestatus >/dev/null 2>/dev/null || \
    _opts+=( --security-opt seccomp=unconfined )

for v in "${VOLUMES[@]}"; do
    eval set -- "$v"
    src=$1
    dst=${2:-$src}
    opt=${3:-}

    test x"$dst" != x- || dst=$src
    _opts+=( -v "$dst:$src$opt" )
done

exec setsid docker run "${_opts[@]}" \
     ${FINAL_NAME}:${DISTRIBUTION}
