#! /bin/bash

: ${SOCAT:=@SOCAT@}
: ${ELITO_CRT:=@ELITO_CRT@}
: ${ELITO_KEY:=$ELITO_CRT}
: ${ELITO_USE_LIBPROXY:=@HAVE_LIBPROXY@}
: ${ELITO_PROG_PROXY:=@PROXY@}
: ${ELITO_PROG_SSL_CLIENT:=@SIGMA_SSL_CLIENT@}

SOCAT_SSLFLAGS="method=TLS,cert=$ELITO_CRT,key=$ELITO_KEY"

_find_proxy() {
    if ${ELITO_USE_LIBPROXY}; then
	${ELITO_PROG_PROXY} "https://$1:$2" 2>/dev/null
    else
	echo "direct://"
    fi
}

find_proxy() {
    _varname=$1
    _dsthost=$2
    _dstport=$3

    shift

    _p=`_find_proxy "$@"`
    old_IFS=$IFS
    IFS=/
    set -- $_p
    proto=$1
    # skip // from proto://...
    shift 2

    # strip proxyauth
    _p=${1#*@}
    _a=${1%$_p}
    _a=${_a%@}
    shift

    IFS=:
    set -- $_p $*
    IFS=$old_IFS

    socat_proxyauth=${socat_proxyauth:-$_a}

    _res=
    case $proto in
      direct:)	_res=TCP:$_dsthost:$_dstport;;
      http:)	_res=PROXY:$1:$_dsthost:$_dstport${2:+,proxyport=$2}${socat_proxyauth:+,proxyauth="$socat_proxyauth"};;
    esac

    eval $_varname=\$_res
}

socat_listen=-
socat_proxyauth=
_auth=

while true; do
    case $1 in
      #--listen)	socat_listen=TCP-LISTEN:$2,reuseaddr,fork; shift 2;;
      --proxyauth)
	    _auth=$2
	    shift 2
	    ;;
      --proxyauth=*)
	    _auth=${1##--proxyauth=}
	    shift
	    ;;
      --)	shift; break;;
      --*)	echo "Unknown option '$1'" >&2; exit 1;;
      *)	break;;
    esac
done

case $_auth in
  ENV:*)
	eval socat_proxyauth=\${${_auth##ENV:}}
	;;
  FILE:*)
	eval read socat_proxyauth \< ${_auth##FILE:}
	;;
  STRING:*)
	socat_proxyauth=${_auth##STRING:}
	;;
  *)
	socat_proxyauth=$_auth
	;;
esac

find_proxy socat_proxy "$@"

${ELITO_PROG_SSL_CLIENT} --keyfile ${ELITO_KEY} --crtfile ${ELITO_CRT} -- ${SOCAT} - ${socat_proxy:+${socat_proxy}}
